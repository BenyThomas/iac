# Fluent Bit DaemonSet shipping container, ingress, platform, and node logs to Loki

serviceAccount:
  create: true

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

tolerations:
  - operator: "Exists"

config:
  service: |
    [SERVICE]
        Flush        5
        Daemon       Off
        Log_Level    info
        Parsers_File parsers.conf
        HTTP_Server  On
        HTTP_Listen  0.0.0.0
        HTTP_Port    2020

  inputs: |
    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        Parser            cri
        Tag               kube.*
        Mem_Buf_Limit     10MB
        Skip_Long_Lines   On
        Refresh_Interval  10
    [INPUT]
        Name              systemd
        Tag               systemd.*
        Systemd_Filter    _SYSTEMD_UNIT=kubelet.service
        Systemd_Filter    _SYSTEMD_UNIT=containerd.service
        Systemd_Filter    _SYSTEMD_UNIT=NetworkManager.service
        Systemd_Filter    _SYSTEMD_UNIT=flanneld.service
        Read_From_Tail    On

  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Merge_Log           On
        Keep_Log            Off
        Kube_Tag_Prefix     kube.var.log.containers.
        Annotations         Off
        Labels              On
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
    [FILTER]
        Name                modify
        Match               kube.*
        Add                  cluster onprem-rke2
    [FILTER]
        Name                throttle
        Match               kube.*
        Rate                6000
        Window              30
        Print_Status        On

  outputs: |
    [OUTPUT]
        Name              loki
        Match             kube.*
        Host              loki-gateway.logging.svc
        Port              80
        Labels            job=fluentbit,cluster=onprem-rke2
        Auto_Kubernetes_Labels On
        LineFormat        json
    [OUTPUT]
        Name              loki
        Match             systemd.*
        Host              loki-gateway.logging.svc
        Port              80
        Labels            job=fluentbit-systemd,cluster=onprem-rke2
        LineFormat        json

  customParsers: |
    [PARSER]
        Name        cri
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[FP]) (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
